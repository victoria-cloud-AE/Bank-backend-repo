# name: Bank Backend Pipeline

# on:
#   push:
#     branches:
#       - main
#   # pull_request:
#   #   branches:
#   #     - cicd

# jobs:
#   Continues-Integration_build_and_push:
#     runs-on: ubuntu-latest
#     env:
#       ECR_REGISTRY: 650891365688.dkr.ecr.us-east-1.amazonaws.com
#       ECR_REPOSITORY: bank-backendapi
#       AWS_REGION: us-east-1
#       IMAGE_TAG: ${{ github.run_number }}

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v4

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Configure AWS credentials
#       uses: aws-actions/configure-aws-credentials@v4
#       with:
#         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         aws-region: ${{ env.AWS_REGION }}

#     - name: Log in to Amazon ECR
#       id: login-ecr
#       uses: aws-actions/amazon-ecr-login@v2

#     - name: Build Docker image
#       run: |
#         docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ./Bank-backend-repo
#         docker tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
  
#     - name: Push Docker images to ECR
#       run: |
#         docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
#         docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

#     - name: Clean up Docker images locally
#       if: always()
#       run: |
#         docker rmi ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} || true
#         docker rmi ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest || true

  
#   Continues-Update_k8s_manifest:
#     runs-on: ubuntu-latest
#     needs: Continues-Integration_build_and_push
#     env:
#       ECR_REGISTRY: 650891365688.dkr.ecr.us-east-1.amazonaws.com
#       ECR_REPOSITORY: bank-backendapi
#       IMAGE_TAG: ${{ github.run_number }}
#     steps:
#     - name: Checkout repository
#       env:
#           GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
#           GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
#       run: |
#          git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/victoria-cloud-AE/kubernetes-repo.git
         
#          cd kubernetes-repo
#          git config user.email "victoriaenuma@gmail.com"
#          git config user.name "victoria-cloud-AE"

#          sed -i "s+${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:.*+${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}+g" ./bank-project/backendapi.yaml

#          cat ./bank-project/backendapi.yaml | grep -q "${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"

#          git add bank-project/backendapi.yaml
#          git commit -m "Update backendapi image to version ${{ env.IMAGE_TAG }}"
#          git push origin main
        


name: Bank Backend Pipeline

on:
  push:
    branches:
      - main

jobs:
  Continues-Integration_build_and_push:
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: 650891365688.dkr.ecr.us-east-1.amazonaws.com
      ECR_REPOSITORY: bank-backendapi
      AWS_REGION: us-east-1
      IMAGE_TAG: ${{ github.run_number }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: List repo contents (debug)
      run: ls -R

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Log in to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build Docker image
      run: |
        docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .
        docker tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

    - name: Push Docker images to ECR
      run: |
        docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

    - name: Clean up Docker images locally
      if: always()
      run: |
        docker rmi ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} || true
        docker rmi ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest || true

  # Continues-Update_k8s_manifest:
  #   runs-on: ubuntu-latest
  #   needs: Continues-Integration_build_and_push
  #   env:
  #     ECR_REGISTRY: 650891365688.dkr.ecr.us-east-1.amazonaws.com
  #     ECR_REPOSITORY: bank-backendapi
  #     IMAGE_TAG: ${{ github.run_number }}
  #   steps:
  #   - name: Checkout repository
  #     env:
  #       GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
  #       GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
  #     run: |
  #        git clone https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_PASSWORD }}@github.com/victoria-cloud-AE/Kubernetes-repo.git

  #        cd Kubernetes-repo
  #        git config user.email "victoriaenuma@gmail.com"
  #        git config user.name "victoria-cloud-AE"

  #        sed -i "s+${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:.*+${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}+g" ./bank-project/backendapi.yaml

  #        cat ./bank-project/backendapi.yaml | grep -q "${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"

  #        git add bank-project/backendapi.yaml
  #        git commit -m "Update backendapi image to version ${{ env.IMAGE_TAG }}"
  #        git push origin main




# Continues-Update_k8s_manifest:
#   runs-on: ubuntu-latest
#   needs: Continues-Integration_build_and_push
#   env:
#     ECR_REGISTRY: 650891365688.dkr.ecr.us-east-1.amazonaws.com
#     ECR_REPOSITORY: bank-backendapi
#     IMAGE_TAG: ${{ github.run_number }}
#   steps:
#     - name: Checkout repository
#       run: |
#         # URL-encode the PAT to handle special characters
#         ENCODED_PAT=$(python3 -c "import urllib.parse, os; print(urllib.parse.quote(os.environ['GIT_PASSWORD']))")
        
#         # Clone the Kubernetes repo using username and encoded PAT
#         git clone https://${GIT_USERNAME}:${ENCODED_PAT}@github.com/victoria-cloud-AE/Kubernetes-repo.git
#         cd Kubernetes-repo

#         # Configure git
#         git config user.email "victoriaenuma@gmail.com"
#         git config user.name "victoria-cloud-AE"

#         # Update image tag in manifest
#         sed -i "s+${ECR_REGISTRY}/${ECR_REPOSITORY}:.*+${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}+g" ./bank-project/backendapi.yaml

#         # Commit changes if any
#         git add ./bank-project/backendapi.yaml
#         git diff --cached --quiet || git commit -m "Update backendapi image to version ${IMAGE_TAG}"

#         # Push changes
#         git push origin main
#       env:
#         GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
#         GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}



Continues-Update_k8s_manifest:
  runs-on: ubuntu-latest
  needs: Continues-Integration_build_and_push
  env:
    ECR_REGISTRY: 650891365688.dkr.ecr.us-east-1.amazonaws.com
    ECR_REPOSITORY: bank-backendapi
    IMAGE_TAG: ${{ github.run_number }}
  steps:
    - name: Checkout Kubernetes repo
      uses: actions/checkout@v4
      with:
        repository: victoria-cloud-AE/Kubernetes-repo
        token: ${{ secrets.GIT_PASSWORD }}
        path: kubernetes-repo

    - name: Update backend image in manifest
      working-directory: kubernetes-repo
      run: |
        git config user.email "victoriaenuma@gmail.com"
        git config user.name "victoria-cloud-AE"
        
        sed -i "s+${ECR_REGISTRY}/${ECR_REPOSITORY}:.*+${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}+g" ./bank-project/backendapi.yaml

        git add ./bank-project/backendapi.yaml
        git diff --cached --quiet || git commit -m "Update backendapi image to version ${IMAGE_TAG}"
        git push origin main
